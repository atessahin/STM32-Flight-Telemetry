#include "ssd1306.h"
#include "i2c_bus.h"


static uint8_t SSD1306_Buffer[SSD1306_WIDTH * SSD1306_HEIGHT / 8];

typedef struct {
	uint16_t CurrentX;
	uint16_t CurrentY;
} SSD1306_t;

static SSD1306_t SSD1306;


static void ssd1306_WriteCommand(uint8_t command) {
	i2cWrite(SSD1306_I2C_ADDR, 0x00, &command, 1);
}


void ssd1306_Init(void) {
	// Standard SSD1306 Initialization Commands (Configures the display controller)
	ssd1306_WriteCommand(0xAE); // Display OFF
	ssd1306_WriteCommand(0x20); // Set Memory Addressing Mode
	ssd1306_WriteCommand(0x00); // Horizontal Addressing Mode
	ssd1306_WriteCommand(0xB0); // Set Page Start Address for Page Addressing Mode
	ssd1306_WriteCommand(0xC8); // Set COM Output Scan Direction (Remapped)
	ssd1306_WriteCommand(0x00); // Set low column address
	ssd1306_WriteCommand(0x10); // Set high column address
	ssd1306_WriteCommand(0x40); // Set Display Start Line
	ssd1306_WriteCommand(0x81); // Set Contrast Control
	ssd1306_WriteCommand(0xFF); // Max Contrast
	ssd1306_WriteCommand(0xA1); // Set Segment Re-map (Remapped)
	ssd1306_WriteCommand(0xA6); // Normal Display (Non-Inverted)
	ssd1306_WriteCommand(0xA8); // Set Multiplex Ratio
	ssd1306_WriteCommand(0x3F); // 1/64 duty
	ssd1306_WriteCommand(0xA4); // Output Follows RAM Content
	ssd1306_WriteCommand(0xD3); // Set Display Offset
	ssd1306_WriteCommand(0x00);
	ssd1306_WriteCommand(0xD5); // Set Display Clock Divide Ratio
	ssd1306_WriteCommand(0xF0);
	ssd1306_WriteCommand(0xD9); // Set Pre-charge Period
	ssd1306_WriteCommand(0x22);
	ssd1306_WriteCommand(0xDA); // Set COM Pins Hardware Configuration
	ssd1306_WriteCommand(0x12);
	ssd1306_WriteCommand(0xDB); // Set VCOMH Deselect Level
	ssd1306_WriteCommand(0x20);
	ssd1306_WriteCommand(0x8D); // Charge Pump Setting (CRITICAL for power)
	ssd1306_WriteCommand(0x14); // Enable Charge Pump
	ssd1306_WriteCommand(0xAF); // Display ON

	ssd1306_Fill(Black); // Clear internal buffer
	ssd1306_UpdateScreen(); // Push cleared buffer to display RAM
}


void ssd1306_Fill(SSD1306_COLOR color) {
	memset(SSD1306_Buffer, (color == Black) ? 0x00 : 0xFF, sizeof(SSD1306_Buffer));
}


void ssd1306_UpdateScreen(void) {

	i2cWrite(SSD1306_I2C_ADDR, 0x40, SSD1306_Buffer, sizeof(SSD1306_Buffer));
}


void ssd1306_DrawPixel(uint8_t x, uint8_t y, SSD1306_COLOR color) {
	if (x >= SSD1306_WIDTH || y >= SSD1306_HEIGHT) return;

	if (color == White) {

		SSD1306_Buffer[x + (y / 8) * SSD1306_WIDTH] |= (1 << (y % 8));
	} else {

		SSD1306_Buffer[x + (y / 8) * SSD1306_WIDTH] &= ~(1 << (y % 8));
	}
}


void ssd1306_SetCursor(uint8_t x, uint8_t y) {
	SSD1306.CurrentX = x;
	SSD1306.CurrentY = y;
}

static char ssd1306_WriteChar(char ch, FontDef Font, SSD1306_COLOR color) {
	uint32_t i, b, j;
	if (ch < 32 || ch > 126) return 0;

	if (SSD1306_WIDTH < (SSD1306.CurrentX + Font.width) ||
		SSD1306_HEIGHT < (SSD1306.CurrentY + Font.height)) {
		return 0;
	}

	for (i = 0; i < Font.height; i++) {

		b = Font.data[(ch - 32) * Font.height + i];
		for (j = 0; j < Font.width; j++) {
			if ((b << j) & 0x8000) {
				ssd1306_DrawPixel(SSD1306.CurrentX + j, (SSD1306.CurrentY + i), (SSD1306_COLOR) color);
			} else {

				ssd1306_DrawPixel(SSD1306.CurrentX + j, (SSD1306.CurrentY + i), (SSD1306_COLOR) !color);
			}
		}
	}
	SSD1306.CurrentX += Font.width;
	return ch;
}

char ssd1306_WriteString(char* str, FontDef Font, SSD1306_COLOR color) {
	while (*str) {
		if (ssd1306_WriteChar(*str, Font, color) != *str) {
			return *str; 		}
		str++;
	}
	return *str;
}

// --- FONT DATA (7x10) ---
const uint16_t Font7x10_Data [] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // Space
    0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x0000, 0x2000, 0x0000, 0x0000, // !
    0x5000, 0x5000, 0x5000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // "
    0x5000, 0x5000, 0xF800, 0x5000, 0xF800, 0x5000, 0x5000, 0x0000, 0x0000, 0x0000, // #
    0x2000, 0x7800, 0xA000, 0x7000, 0x2800, 0xF000, 0x2000, 0x0000, 0x0000, 0x0000, // $
    0xC000, 0xC800, 0x1000, 0x2000, 0x4000, 0x9800, 0x1800, 0x0000, 0x0000, 0x0000, // %
    0x4000, 0xA000, 0xA000, 0x4000, 0xA800, 0x9000, 0x6800, 0x0000, 0x0000, 0x0000, // &
    0x2000, 0x2000, 0x2000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // '
    0x1000, 0x2000, 0x4000, 0x4000, 0x4000, 0x4000, 0x2000, 0x1000, 0x0000, 0x0000, // (
    0x4000, 0x2000, 0x1000, 0x1000, 0x1000, 0x1000, 0x2000, 0x4000, 0x0000, 0x0000, // )
    0x0000, 0x2000, 0xA800, 0x7000, 0xA800, 0x2000, 0x0000, 0x0000, 0x0000, 0x0000, // *
    0x0000, 0x2000, 0x2000, 0xF800, 0x2000, 0x2000, 0x0000, 0x0000, 0x0000, 0x0000, // +
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x2000, 0x2000, 0x4000, 0x0000, 0x0000, // ,
    0x0000, 0x0000, 0x0000, 0xF800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // -
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6000, 0x6000, 0x0000, 0x0000, // .
    0x0000, 0x0800, 0x1000, 0x2000, 0x4000, 0x8000, 0x0000, 0x0000, 0x0000, 0x0000, // /
    0x7000, 0x8800, 0x9800, 0xA800, 0xC800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // 0
    0x2000, 0x6000, 0x2000, 0x2000, 0x2000, 0x2000, 0x7000, 0x0000, 0x0000, 0x0000, // 1
    0x7000, 0x8800, 0x0800, 0x1000, 0x2000, 0x4000, 0xF800, 0x0000, 0x0000, 0x0000, // 2
    0xF800, 0x0800, 0x1000, 0x3000, 0x0800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // 3
    0x1000, 0x3000, 0x5000, 0x9000, 0xF800, 0x1000, 0x1000, 0x0000, 0x0000, 0x0000, // 4
    0xF800, 0x8000, 0xF000, 0x0800, 0x0800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // 5
    0x3000, 0x4000, 0x8000, 0xF000, 0x8800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // 6
    0xF800, 0x0800, 0x1000, 0x2000, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000, 0x0000, // 7
    0x7000, 0x8800, 0x8800, 0x7000, 0x8800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // 8
    0x7000, 0x8800, 0x8800, 0x7800, 0x0800, 0x1000, 0x6000, 0x0000, 0x0000, 0x0000, // 9
    0x0000, 0x6000, 0x6000, 0x0000, 0x6000, 0x6000, 0x0000, 0x0000, 0x0000, 0x0000, // :
    0x0000, 0x6000, 0x6000, 0x0000, 0x6000, 0x2000, 0x4000, 0x0000, 0x0000, 0x0000, // ;
    0x0800, 0x1000, 0x2000, 0x4000, 0x2000, 0x1000, 0x0800, 0x0000, 0x0000, 0x0000, // <
    0x0000, 0x0000, 0xF800, 0x0000, 0xF800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // =
    0x4000, 0x2000, 0x1000, 0x0800, 0x1000, 0x2000, 0x4000, 0x0000, 0x0000, 0x0000, // >
    0x7000, 0x8800, 0x0800, 0x3000, 0x2000, 0x0000, 0x2000, 0x0000, 0x0000, 0x0000, // ?
    0x7000, 0x8800, 0xA800, 0xA800, 0xA800, 0x8000, 0x7800, 0x0000, 0x0000, 0x0000, // @
    0x2000, 0x5000, 0x8800, 0x8800, 0xF800, 0x8800, 0x8800, 0x0000, 0x0000, 0x0000, // A
    0xF000, 0x8800, 0x8800, 0xF000, 0x8800, 0x8800, 0xF000, 0x0000, 0x0000, 0x0000, // B
    0x7000, 0x8800, 0x8000, 0x8000, 0x8000, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // C
    0xF000, 0x8800, 0x8800, 0x8800, 0x8800, 0x8800, 0xF000, 0x0000, 0x0000, 0x0000, // D
    0xF800, 0x8000, 0x8000, 0xF000, 0x8000, 0x8000, 0xF800, 0x0000, 0x0000, 0x0000, // E
    0xF800, 0x8000, 0x8000, 0xF000, 0x8000, 0x8000, 0x8000, 0x0000, 0x0000, 0x0000, // F
    0x7000, 0x8800, 0x8000, 0x9800, 0x8800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // G
    0x8800, 0x8800, 0x8800, 0xF800, 0x8800, 0x8800, 0x8800, 0x0000, 0x0000, 0x0000, // H
    0x7000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x7000, 0x0000, 0x0000, 0x0000, // I
    0x3800, 0x1000, 0x1000, 0x1000, 0x1000, 0x9000, 0x6000, 0x0000, 0x0000, 0x0000, // J
    0x8800, 0x9000, 0xA000, 0xC000, 0xA000, 0x9000, 0x8800, 0x0000, 0x0000, 0x0000, // K
    0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0xF800, 0x0000, 0x0000, 0x0000, // L
    0x8800, 0xD800, 0xA800, 0x8800, 0x8800, 0x8800, 0x8800, 0x0000, 0x0000, 0x0000, // M
    0x8800, 0xC800, 0xA800, 0x9800, 0x8800, 0x8800, 0x8800, 0x0000, 0x0000, 0x0000, // N
    0x7000, 0x8800, 0x8800, 0x8800, 0x8800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // O
    0xF000, 0x8800, 0x8800, 0xF000, 0x8000, 0x8000, 0x8000, 0x0000, 0x0000, 0x0000, // P
    0x7000, 0x8800, 0x8800, 0x8800, 0xA800, 0x9800, 0x7800, 0x0000, 0x0000, 0x0000, // Q
    0xF000, 0x8800, 0x8800, 0xF000, 0xA000, 0x9000, 0x8800, 0x0000, 0x0000, 0x0000, // R
    0x7000, 0x8800, 0x8000, 0x7000, 0x0800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // S
    0xF800, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x0000, 0x0000, 0x0000, // T
    0x8800, 0x8800, 0x8800, 0x8800, 0x8800, 0x8800, 0x7000, 0x0000, 0x0000, 0x0000, // U
    0x8800, 0x8800, 0x8800, 0x8800, 0x5000, 0x5000, 0x2000, 0x0000, 0x0000, 0x0000, // V
    0x8800, 0x8800, 0x8800, 0xA800, 0xA800, 0xA800, 0x5000, 0x0000, 0x0000, 0x0000, // W
    0x8800, 0x8800, 0x5000, 0x2000, 0x5000, 0x8800, 0x8800, 0x0000, 0x0000, 0x0000, // X
    0x8800, 0x8800, 0x5000, 0x2000, 0x2000, 0x2000, 0x2000, 0x0000, 0x0000, 0x0000, // Y
    0xF800, 0x0800, 0x1000, 0x2000, 0x4000, 0x8000, 0xF800, 0x0000, 0x0000, 0x0000  // Z
};

FontDef Font_7x10 = {7, 10, Font7x10_Data};
